// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ProductCategory {
  NFC_CARD
  NFC_TAG
}

enum ReviewRating {
  ONE
  TWO
  THREE
  FOUR
  FIVE
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  OVERNIGHT
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String
  name                String
  phone               String?
  role                UserRole @default(USER)
  
  // Email & Account
  emailVerified       Boolean  @default(false)
  emailVerificationToken String?
  passwordResetToken  String?
  passwordResetExpires DateTime?
  
  // Profile
  avatar              String?
  bio                 String?
  
  // Addresses
  addresses           Address[]
  defaultAddressId    String?
  
  // Payment Methods
  savedPaymentMethods SavedPaymentMethod[]
  
  // Relations
  cart                Cart?
  orders              Order[]
  coupons             Coupon[]
  reviews             Review[]
  wishlist            Wishlist?
  newsSubscription    NewsSubscription?
  notifications       Notification[]
  refundRequests      RefundRequest[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Product {
  id          String          @id @default(uuid())
  name        String
  description String
  price       Float
  stock       Int
  category    ProductCategory
  model       String?
  specs       Json?
  images      String[]
  
  // Additional fields
  sku         String?         @unique
  isDigital   Boolean         @default(false)
  downloadUrl String?
  
  // Variants
  variants    ProductVariant[]
  
  // Reviews & Ratings
  reviews     Review[]
  averageRating Float?
  totalReviews Int @default(0)
  
  // SEO
  slug        String          @unique
  seoTitle    String?
  seoDescription String?
  seoKeywords String?
  
  // Relations
  cartItems   CartItem[]
  orderItems  OrderItem[]
  wishlistItems WishlistItem[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
}

model Order {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  items           OrderItem[]
  totalAmount     Float
  paymentStatus   PaymentStatus @default(PENDING)
  orderStatus     OrderStatus   @default(PENDING)
  razorpayOrderId String?
  razorpayPaymentId String?
  couponCode      String?
  discountAmount  Float         @default(0)
  
  // Shipping
  shippingAddressId String?
  shippingAddress Address?      @relation("OrderShipping", fields: [shippingAddressId], references: [id])
  shippingMethod  ShippingMethod @default(STANDARD)
  shippingCost    Float         @default(0)
  trackingNumber  String?
  estimatedDelivery DateTime?
  
  // Tax
  taxAmount       Float         @default(0)
  
  // Returns & Refunds
  refundRequests  RefundRequest[]
  
  // Notifications
  notifications   Notification[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
}

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  discountType String  // "PERCENTAGE" or "FIXED"
  discountValue Float
  minAmount   Float?
  maxDiscount Float?
  usageLimit  Int?
  usedCount   Int      @default(0)
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean  @default(true)
  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== NEW MODELS ==========

model Address {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  phone         String
  street        String
  city          String
  state         String
  pincode       String
  country       String @default("India")
  isDefault     Boolean @default(false)
  orderShipping Order[] @relation("OrderShipping")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductVariant {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String   // e.g., "Red", "Large"
  value       String   // e.g., color value, size value
  stock       Int
  price       Float?   // Additional cost if different
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Review {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating      ReviewRating
  title       String
  comment     String
  helpfulCount Int @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, userId])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WishlistItem {
  id        String   @id @default(uuid())
  wishlistId String
  wishlist  Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([wishlistId, productId])
}

model SavedPaymentMethod {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "card", "upi", "wallet"
  lastFour  String   // Last 4 digits
  token     String   @unique
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefundRequest {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  reason      String
  status      ReturnStatus @default(PENDING)
  refundAmount Float
  notes       String?
  processedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  type      String   // "ORDER_UPDATE", "PROMOTION", "GENERAL"
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NewsSubscription {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String
  excerpt     String?
  author      String
  image       String?
  published   Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FAQ {
  id        String   @id @default(uuid())
  question  String
  answer    String
  category  String   // e.g., "Shipping", "Payment", "Product"
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StaticPage {
  id        String   @id @default(uuid())
  slug      String   @unique // e.g., "about", "contact", "privacy", "terms"
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "order_confirmation", "password_reset"
  subject   String
  body      String
  variables String[] // Variables to use in template
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String   // e.g., "PRODUCT_CREATED", "ORDER_UPDATED"
  entity    String   // e.g., "Product", "Order"
  entityId  String?
  changes   Json?    // What changed
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}
